{% extends "layout.html" %}

{% block title %}Dashboard{% endblock %}

{% block head %}
<meta http-equiv="refresh" content="30">
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
{% endblock %}

{% block content %}
<section class="dashboard">
    <div class="card system-info">
        <h2>System Status</h2>
        <div class="info-grid">
            <div class="info-item">
                <span class="info-label">Uptime:</span>
                <span class="info-value">{{ uptime }}</span>
            </div>
            
            {% for key, value in system_state.system_info.items() %}
            <div class="info-item">
                <span class="info-label">{{ key|capitalize }}:</span>
                <span class="info-value">{{ value }}</span>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="card modules">
        <h2>Module Status</h2>
        <div class="module-grid">
            {% for name, data in system_state.modules_status.items() %}
            <div class="module-item">
                <div class="module-name">{{ name }}</div>
                <div class="module-status status-{{ data.status|lower }}">{{ data.status }}</div>
                {% if data.details %}
                <div class="module-details">{{ data.details }}</div>
                {% endif %}
                <div class="module-updated">Last update: {{ data.last_update }}</div>
            </div>
            {% else %}
            <p>No module status information available.</p>
            {% endfor %}
        </div>
    </div>
    
    <div class="card chart">
        <h2>Deauth Frames (Real-time)</h2>
        <div class="deauth-chart-container">
            <canvas id="deauthChart"></canvas>
        </div>
        <div class="chart-description">
            <p>Shows deauthentication frames in 5-second intervals. Blue bars show normal activity, red bars indicate when frames exceed the alert threshold (yellow line).</p>
        </div>
    </div>

    <div class="card chart">
        <h2>RF Spectrum</h2>
        <div class="spectrum-chart-container">
            <canvas id="spectrumChart"></canvas>
        </div>
    </div>
    
    <div class="card chart">
        <h2>Attack History</h2>
        <div class="attack-chart-container">
            <canvas id="attackChart"></canvas>
        </div>
    </div>

    <div class="card recent-events">
        <h2>Recent Events</h2>
        {% if system_state.last_events %}
        <div class="events-list">
            {% for event in system_state.last_events %}
            <div class="event-item event-{{ event.event_type }}">
                <div class="event-header">
                    <span class="event-type">{{ event.event_type|replace('_', ' ')|capitalize }}</span>
                    <span class="event-time">{{ event.timestamp }}</span>
                </div>
                <div class="event-details">
                    <pre>{{ event|tojson(indent=2) }}</pre>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p>No attack events detected yet.</p>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
// Initialize charts
let spectrumChart = null;
let attackChart = null;
let deauthChart = null;

// Fetch deauth frames data
function updateDeauthChart() {
    fetch('/api/graph/deauth_frames')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('deauthChart').getContext('2d');
            
            // Destroy previous chart if it exists
            if (deauthChart) {
                deauthChart.destroy();
            }
            
            // Get threshold value from the data
            const threshold = data.datasets[1].data[0]; // Get threshold from the second dataset
            
            // Modify color of bars based on threshold
            const originalData = data.datasets[0].data;
            const backgroundColors = originalData.map(value => 
                value >= threshold ? 'rgba(231, 76, 60, 0.7)' : 'rgba(52, 152, 219, 0.6)'
            );
            const borderColors = originalData.map(value => 
                value >= threshold ? 'rgba(231, 76, 60, 1)' : 'rgba(52, 152, 219, 1)'
            );
            
            // Create a new dataset just for the legend with the alert color
            // Update the original dataset label
            data.datasets[0].label = 'Normal Frames';
            data.datasets[0].backgroundColor = 'rgba(52, 152, 219, 0.6)';  // Blue for normal
            data.datasets[0].borderColor = 'rgba(52, 152, 219, 1)';
            
            // Create an alert dataset with transparent bars for values below threshold
            // and red bars for values above threshold
            const alertData = originalData.map(value => 
                value >= threshold ? value : null  // Only show values above threshold
            );
            
            // Add the alert dataset
            data.datasets.splice(1, 0, {
                label: 'Alert Threshold Exceeded',
                data: alertData,
                backgroundColor: 'rgba(231, 76, 60, 0.7)',
                borderColor: 'rgba(231, 76, 60, 1)',
                borderWidth: 1,
                barPercentage: 0.9,
                categoryPercentage: 0.9,
                stack: 'stack1' // Use stacking to ensure bars don't overlap
            });
            
            // Also stack the normal frames
            data.datasets[0].stack = 'stack1';
            
            // Original dataset now uses plain colors
            // but we make points under the alert level null so they don't show
            data.datasets[0].data = originalData.map(value => 
                value < threshold ? value : null
            );
            
            // Create new chart
            deauthChart = new Chart(ctx, {
                type: 'bar', // Changed from line to bar for better visibility
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            },
                            ticks: {
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 6, // Even fewer time labels for better readability
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Frame Count'
                            },
                            beginAtZero: true,
                            suggestedMax: 12,  // Even lower max to make small numbers more visible
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)', // Darker grid lines
                            },
                            ticks: {
                                stepSize: 1,  // Always use whole numbers
                                font: {
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 300  // Even faster animation for real-time updates
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Deauthentication Frames (10s intervals)'
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 14
                            },
                            callbacks: {
                                title: function(tooltipItems) {
                                    return tooltipItems[0].label;
                                },
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y;
                                        if (context.dataset.label === 'Deauth Frames') {
                                            label += ' frames';
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        })
        .catch(error => console.error('Error fetching deauth data:', error));
}

// Fetch spectrum data
function updateSpectrumChart() {
    fetch('/api/graph/spectrum')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('spectrumChart').getContext('2d');
            
            // Destroy previous chart if it exists
            if (spectrumChart) {
                spectrumChart.destroy();
            }
            
            // Create new chart
            spectrumChart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Frequency (MHz)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Power (dBm)'
                            }
                        }
                    },
                    animation: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'RF Spectrum Power Levels'
                        }
                    }
                }
            });
        })
        .catch(error => console.error('Error fetching spectrum data:', error));
}

// Fetch attack history data
function updateAttackChart() {
    fetch('/api/graph/attack_history')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('attackChart').getContext('2d');
            
            // Destroy previous chart if it exists
            if (attackChart) {
                attackChart.destroy();
            }
            
            // Log the data for debugging
            console.log('Attack history data:', data);
            
            // If there's no data, create an empty chart
            if (!data.labels || data.labels.length === 0) {
                data = {
                    labels: ['No Data'],
                    datasets: [{
                        label: 'No Attack History',
                        data: [0],
                        backgroundColor: 'rgba(200, 200, 200, 0.5)',
                    }]
                };
            }
            
            // Create new chart
            attackChart = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Number of Attacks'
                            },
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Attack History by Day'
                        }
                    }
                }
            });
        })
        .catch(error => console.error('Error fetching attack history data:', error));
}

// Initial load
window.addEventListener('load', function() {
    updateDeauthChart();
    updateSpectrumChart();
    updateAttackChart();
    
    // Update charts periodically
    setInterval(updateDeauthChart, 1000);    // Update deauth chart every second
    setInterval(updateSpectrumChart, 5000);  // Update spectrum chart every 5 seconds
    setInterval(updateAttackChart, 60000);   // Update attack history chart every minute
});

// Auto-refresh the page every 30 seconds
// Check for new alerts every 3 seconds
let lastEventCount = 0;
function checkForNewAlerts() {
    fetch('/events')
        .then(response => response.json())
        .then(events => {
            if (events.length > lastEventCount && lastEventCount > 0) {
                // New alert!
                const newEvent = events[0];
                showNotification(newEvent.event_type, new Date(newEvent.timestamp).toLocaleTimeString());
            }
            lastEventCount = events.length;
        })
        .catch(error => console.error('Error checking alerts:', error));
}

// Show browser notification
function showNotification(type, time) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.innerHTML = `
        <div class="notification-content">
            <strong>${type.replace('_', ' ').toUpperCase()}</strong>
            <p>Attack detected at ${time}</p>
        </div>
        <button class="close-notification">×</button>
    `;
    
    // Add to body
    document.body.appendChild(notification);
    
    // Add style
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.backgroundColor = '#e74c3c';
    notification.style.color = 'white';
    notification.style.padding = '15px';
    notification.style.borderRadius = '5px';
    notification.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
    notification.style.zIndex = '1000';
    notification.style.minWidth = '300px';
    
    // No sound notification for now
    // We'll use Home Assistant for notifications later
    
    // Close button
    const closeBtn = notification.querySelector('.close-notification');
    closeBtn.style.background = 'none';
    closeBtn.style.border = 'none';
    closeBtn.style.color = 'white';
    closeBtn.style.fontSize = '20px';
    closeBtn.style.fontWeight = 'bold';
    closeBtn.style.cursor = 'pointer';
    closeBtn.style.float = 'right';
    
    closeBtn.addEventListener('click', () => {
        document.body.removeChild(notification);
    });
    
    // Auto remove after 10 seconds
    setTimeout(() => {
        if (document.body.contains(notification)) {
            document.body.removeChild(notification);
        }
    }, 10000);
}

// Start checking for alerts
setInterval(checkForNewAlerts, 3000);

// Auto-refresh the page every 30 seconds
setTimeout(function() {
    location.reload();
}, 30000);
</script>
{% endblock %}
