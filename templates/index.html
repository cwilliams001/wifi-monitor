{% extends "layout.html" %}

{% block title %}Dashboard{% endblock %}

{% block head %}
<meta http-equiv="refresh" content="30">
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
{% endblock %}

{% block content %}
<section class="dashboard">
    <div class="card system-info">
        <h2>System Status</h2>
        <div class="info-grid">
            <div class="info-item">
                <span class="info-label">Uptime:</span>
                <span class="info-value">{{ uptime }}</span>
            </div>
            
            {% for key, value in system_state.system_info.items() %}
            <div class="info-item">
                <span class="info-label">{{ key|capitalize }}:</span>
                <span class="info-value">{{ value }}</span>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="card modules">
        <h2>Module Status</h2>
        <div class="module-grid">
            {% for name, data in system_state.modules_status.items() %}
            <div class="module-item">
                <div class="module-name">{{ name }}</div>
                <div class="module-status status-{{ data.status|lower }}">{{ data.status }}</div>
                {% if data.details %}
                <div class="module-details">{{ data.details }}</div>
                {% endif %}
                <div class="module-updated">Last update: {{ data.last_update }}</div>
            </div>
            {% else %}
            <p>No module status information available.</p>
            {% endfor %}
        </div>
    </div>
    
    <div class="card chart">
        <h2>RF Spectrum</h2>
        <div class="spectrum-chart-container">
            <canvas id="spectrumChart"></canvas>
        </div>
    </div>
    
    <div class="card chart">
        <h2>Attack History</h2>
        <div class="attack-chart-container">
            <canvas id="attackChart"></canvas>
        </div>
    </div>

    <div class="card recent-events">
        <h2>Recent Events</h2>
        {% if system_state.last_events %}
        <div class="events-list">
            {% for event in system_state.last_events %}
            <div class="event-item event-{{ event.event_type }}">
                <div class="event-header">
                    <span class="event-type">{{ event.event_type|replace('_', ' ')|capitalize }}</span>
                    <span class="event-time">{{ event.timestamp }}</span>
                </div>
                <div class="event-details">
                    <pre>{{ event|tojson(indent=2) }}</pre>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p>No attack events detected yet.</p>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
// Initialize charts
let spectrumChart = null;
let attackChart = null;

// Fetch spectrum data
function updateSpectrumChart() {
    fetch('/api/graph/spectrum')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('spectrumChart').getContext('2d');
            
            // Destroy previous chart if it exists
            if (spectrumChart) {
                spectrumChart.destroy();
            }
            
            // Create new chart
            spectrumChart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Frequency (MHz)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Power (dBm)'
                            }
                        }
                    },
                    animation: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'RF Spectrum Power Levels'
                        }
                    }
                }
            });
        })
        .catch(error => console.error('Error fetching spectrum data:', error));
}

// Fetch attack history data
function updateAttackChart() {
    fetch('/api/graph/attack_history')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('attackChart').getContext('2d');
            
            // Destroy previous chart if it exists
            if (attackChart) {
                attackChart.destroy();
            }
            
            // Create new chart
            attackChart = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Number of Attacks'
                            },
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Attack History by Day'
                        }
                    }
                }
            });
        })
        .catch(error => console.error('Error fetching attack history data:', error));
}

// Initial load
window.addEventListener('load', function() {
    updateSpectrumChart();
    updateAttackChart();
    
    // Update charts periodically
    setInterval(updateSpectrumChart, 5000);
    setInterval(updateAttackChart, 60000);
});

// Auto-refresh the page every 30 seconds
setTimeout(function() {
    location.reload();
}, 30000);
</script>
{% endblock %}
